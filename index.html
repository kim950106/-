import React, { useState, useEffect, useRef } from 'react';
import { Phone, Map, MessageCircle, Globe, User, Search, Bell, X } from 'lucide-react';

const TourPassApp = () => {
  const [mode, setMode] = useState('basic');
  const [timeRemaining, setTimeRemaining] = useState(24 * 60 * 60);
  const [showScanner, setShowScanner] = useState(false);
  const [showResult, setShowResult] = useState(false);
  const [scanResult, setScanResult] = useState(null);
  const [showDetail, setShowDetail] = useState(null);
  const [adultCount, setAdultCount] = useState(2);
  const [childCount, setChildCount] = useState(1);
  const [favorites, setFavorites] = useState(new Set(['palace', 'cafe']));
  const [language, setLanguage] = useState('ko');
  const [showPopup, setShowPopup] = useState(true);
  const [hidePopupToday, setHidePopupToday] = useState(false);
  const [aiRecommendation, setAiRecommendation] = useState(null);
  const [userAnswers, setUserAnswers] = useState({});
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [currentBanner, setCurrentBanner] = useState(0);
  const [showSurvey, setShowSurvey] = useState(false);
  const [surveyStep, setSurveyStep] = useState(0);
  const [surveyAnswers, setSurveyAnswers] = useState({});
  
  const videoRef = useRef(null);
  const streamRef = useRef(null);

  const bannerAds = [
    {
      id: 1,
      title: '📊 만족도 조사',
      subtitle: '투어패스 이용 후기를 들려주세요!',
      bgColor: 'from-indigo-500 to-purple-600',
      textColor: 'text-white',
      type: 'survey'
    },
    {
      id: 2,
      title: '🎄 크리스마스 특가',
      subtitle: '12월 한정! 투어패스 30% 할인',
      bgColor: 'from-red-500 to-green-600',
      textColor: 'text-white',
      type: 'promotion'
    },
    {
      id: 3,
      title: '🍕 맛집 투어',
      subtitle: '서울 핫플레이스 맛집 특별가',
      bgColor: 'from-orange-400 to-yellow-500',
      textColor: 'text-white',
      type: 'promotion'
    },
    {
      id: 4,
      title: '🎨 체험 프로그램',
      subtitle: '전통공예 체험 + 기념품 증정',
      bgColor: 'from-purple-500 to-pink-600',
      textColor: 'text-white',
      type: 'promotion'
    },
    {
      id: 5,
      title: '📱 앱 전용',
      subtitle: '모바일 예약시 추가 10% 할인',
      bgColor: 'from-blue-500 to-cyan-600',
      textColor: 'text-white',
      type: 'promotion'
    }
  ];

  const statsData = {
    topDestinations: [
      { name: '덕수궁', percentage: 38, type: 'palace' },
      { name: '헤이티', percentage: 28, type: 'cafe' },
      { name: '웃는날공방', percentage: 22, type: 'workshop' }
    ]
  };

  const questionData = [
    {
      id: 'travelStyle',
      question: '어떤 여행 스타일을 선호하시나요?',
      options: ['느긋한 관광', '체험 중심', '사진 촬영', '문화 탐방']
    },
    {
      id: 'groupType',
      question: '누구와 함께 여행하시나요?',
      options: ['혼자', '연인/친구', '가족(아이 동반)', '가족(성인만)']
    },
    {
      id: 'timeAvailable',
      question: '이용 가능한 시간은 얼마나 되나요?',
      options: ['2-3시간', '반나절 (4-5시간)', '종일 (6시간 이상)', '시간 여유 충분']
    },
    {
      id: 'interests',
      question: '가장 관심 있는 활동은?',
      options: ['역사/문화재', '카페/맛집', '체험 활동', '쇼핑']
    }
  ];

  const surveyQuestions = [
    {
      id: 'satisfaction',
      question: '투어패스 서비스에 얼마나 만족하시나요?',
      type: 'rating',
      options: [
        { value: 5, label: '매우 만족', emoji: '😍' },
        { value: 4, label: '만족', emoji: '😊' },
        { value: 3, label: '보통', emoji: '😐' },
        { value: 2, label: '불만족', emoji: '😞' },
        { value: 1, label: '매우 불만족', emoji: '😡' }
      ]
    },
    {
      id: 'recommendation',
      question: '친구나 가족에게 추천하시겠어요?',
      type: 'choice',
      options: [
        { value: 'yes', label: '네, 꼭 추천하겠어요' },
        { value: 'maybe', label: '상황에 따라 추천할 것 같아요' },
        { value: 'no', label: '추천하지 않을 것 같아요' }
      ]
    },
    {
      id: 'improvement',
      question: '가장 개선이 필요한 부분은?',
      type: 'choice',
      options: [
        { value: 'more_places', label: '더 많은 가맹점' },
        { value: 'better_benefits', label: '더 나은 혜택' },
        { value: 'easier_use', label: '사용법 개선' },
        { value: 'customer_service', label: '고객서비스 개선' }
      ]
    }
  ];

  const handleBannerClick = (banner) => {
    if (banner.type === 'survey') {
      setShowSurvey(true);
      setSurveyStep(0);
    } else {
      // 다른 배너들은 기존 동작
      console.log('배너 클릭:', banner.title);
    }
  };

  const handleHidePopupToday = () => {
    setHidePopupToday(true);
    setShowPopup(false);
  };

  useEffect(() => {
    const browserLang = navigator.language || navigator.userLanguage;
    if (browserLang.startsWith('en')) {
      setLanguage('en');
    } else if (browserLang.startsWith('ja')) {
      setLanguage('ja');
    } else if (browserLang.startsWith('zh')) {
      setLanguage('zh');
    } else {
      setLanguage('ko');
    }
  }, []);

  useEffect(() => {
    const bannerTimer = setInterval(() => {
      setCurrentBanner(prev => (prev + 1) % bannerAds.length);
    }, 3000);
    return () => clearInterval(bannerTimer);
  }, []);

  const texts = {
    ko: {
      easyOff: '간편 OFF',
      easyOn: '간편 ON',
      qrAuth: 'QR인증',
      searchPlaceholder: '투어패스 여행지를 검색하세요',
      timeRemaining: '사용가능한 남은 시간을 확인하세요.',
      myFavorites: '나만의 투어패스 리스트',
      freeUse: '자유 이용',
      viewFacilities: '이용가능한 시설보기',
      seeAll: '전체보기 +',
      popularDestinations: '인기 관광지 순위',
      nextDestination: '다음 추천 장소',
      deoksugung: '덕수궁',
      freeEntry: '무료입장',
      haity: '헤이티',
      drinkService: '음료제공',
      laughingDayWorkshop: '웃는날공방',
      travelTopperExperience: '여행토퍼 체험',
      favoritesTitle: '내가 찜한 가맹점',
      noFavorites: '찜한 가맹점이 없습니다.\n하트를 눌러 가맹점을 찜해보세요!',
      mobileAuth: '모바일인증',
      announcement: '공지',
      chatbot: '챗봇',
      language: 'Language',
      close: '닫기',
      confirm: '확인',
      importantNotice: '중요 공지'
    },
    en: {
      easyOff: 'Simple OFF',
      easyOn: 'Simple ON',
      qrAuth: 'QR Auth',
      searchPlaceholder: 'Search tour pass destinations',
      timeRemaining: 'Check your remaining time.',
      myFavorites: 'My Tour Pass List',
      freeUse: 'Free Access',
      viewFacilities: 'View Available Facilities',
      seeAll: 'See All +',
      popularDestinations: 'Popular Destinations Ranking',
      nextDestination: 'Next Recommended Place',
      deoksugung: 'Deoksugung Palace',
      freeEntry: 'Free Entry',
      haity: 'Haity Cafe',
      drinkService: 'Drink Service',
      laughingDayWorkshop: 'Laughing Day Workshop',
      travelTopperExperience: 'Travel Topper Experience',
      favoritesTitle: 'My Favorite Places',
      noFavorites: 'No favorite places yet.\nTap the heart to add favorites!',
      mobileAuth: 'Mobile Auth',
      announcement: 'Notice',
      chatbot: 'Chatbot',
      language: '언어',
      close: 'Close',
      confirm: 'Confirm',
      importantNotice: 'Important Notice'
    }
  };

  const t = texts[language];

  useEffect(() => {
    const timer = setInterval(() => {
      setTimeRemaining(prev => {
        if (prev <= 0) return 0;
        return prev - 1;
      });
    }, 1000);

    return () => clearInterval(timer);
  }, []);

  const generateAIRecommendation = (answers) => {
    const recommendations = {
      cultural: {
        title: '문화 탐방 코스',
        description: '역사와 전통을 체험하는 깊이 있는 여행',
        course: [
          { time: '09:00-10:30', place: '덕수궁', activity: '궁궐 탐방 및 역사 해설', duration: '1시간 30분' },
          { time: '11:00-11:30', place: '헤이티', activity: '전통차와 함께 휴식', duration: '30분' },
          { time: '12:00-13:30', place: '웃는날공방', activity: '전통 공예 체험', duration: '1시간 30분' }
        ],
        tip: '문화재 관람 시 해설 서비스를 이용하시면 더욱 알찬 시간을 보낼 수 있습니다.'
      },
      leisure: {
        title: '여유로운 힐링 코스',
        description: '스트레스를 풀고 재충전하는 편안한 여행',
        course: [
          { time: '10:00-11:00', place: '헤이티', activity: '브런치와 음료', duration: '1시간' },
          { time: '11:30-12:30', place: '덕수궁', activity: '산책과 사진 촬영', duration: '1시간' },
          { time: '13:00-14:00', place: '웃는날공방', activity: '간단한 만들기 체험', duration: '1시간' }
        ],
        tip: '각 장소에서 충분한 시간을 가지고 여유롭게 즐기세요.'
      },
      experience: {
        title: '체험 중심 액티브 코스',
        description: '다양한 활동으로 특별한 추억 만들기',
        course: [
          { time: '09:30-10:30', place: '웃는날공방', activity: '토퍼 만들기 체험', duration: '1시간' },
          { time: '11:00-12:00', place: '덕수궁', activity: '전통 의상 체험', duration: '1시간' },
          { time: '12:30-13:00', place: '헤이티', activity: '바리스타 체험', duration: '30분' }
        ],
        tip: '체험 활동은 예약이 필요할 수 있으니 미리 문의해보세요.'
      }
    };

    if (answers.interests === '역사/문화재' || answers.travelStyle === '문화 탐방') {
      return recommendations.cultural;
    } else if (answers.travelStyle === '느긋한 관광' || answers.timeAvailable === '시간 여유 충분') {
      return recommendations.leisure;
    } else {
      return recommendations.experience;
    }
  };

  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
      });
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        streamRef.current = stream;
      }
      setShowScanner(true);
    } catch (error) {
      console.error('카메라 접근 실패:', error);
      alert('카메라에 접근할 수 없습니다.');
    }
  };

  const stopCamera = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
    setShowScanner(false);
  };

  const simulateQRScan = () => {
    setTimeout(() => {
      const mockResults = [
        {
          time: new Date().toLocaleString('ko-KR'),
          benefit: '아메리카노 1잔 무료',
          notice: '1인 1회 제공, 당일 유효'
        },
        {
          time: new Date().toLocaleString('ko-KR'),
          benefit: '입장료 20% 할인',
          notice: '다른 할인과 중복 불가'
        }
      ];
      
      const randomResult = mockResults[Math.floor(Math.random() * mockResults.length)];
      setScanResult(randomResult);
      stopCamera();
      setShowResult(true);
    }, 2000);
  };

  useEffect(() => {
    if (showScanner && videoRef.current) {
      simulateQRScan();
    }
  }, [showScanner]);

  const toggleFavorite = (placeId) => {
    setFavorites(prev => {
      const newFavorites = new Set(prev);
      if (newFavorites.has(placeId)) {
        newFavorites.delete(placeId);
      } else {
        newFavorites.add(placeId);
      }
      return newFavorites;
    });
  };

  const handleCardClick = (place) => {
    setShowDetail(place);
  };

  const handleHeartClick = (placeId) => {
    toggleFavorite(placeId);
  };

  const formatTime = (seconds) => {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  const BasicMode = () => (
    <div className="min-h-screen bg-gray-100 pb-20">
      <div className="bg-white px-4 py-3 flex items-center justify-between shadow-sm">
        <div className="flex items-center gap-2">
          <span className="text-lg font-medium">조아라 (5970)</span>
          <span className="text-gray-500">▼</span>
        </div>
        <div className="flex items-center gap-3">
          <span className="text-xs text-gray-600">{mode === 'basic' ? t.easyOff : t.easyOn}</span>
          <button 
            onClick={startCamera}
            className="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700"
          >
            {t.qrAuth}
          </button>
        </div>
      </div>

      <div className="bg-white p-4 space-y-3">
        <div className="relative">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={18} />
          <input 
            type="text" 
            placeholder={t.searchPlaceholder}
            className="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg text-sm"
          />
        </div>
      </div>

      <div className="px-4 mb-4">
        <div className="bg-red-500 rounded-lg overflow-hidden shadow-lg">
          <div className="p-4 text-center text-white">
            <div className="text-sm mb-2">{t.timeRemaining}</div>
            <div className="text-4xl font-bold mb-6">{formatTime(timeRemaining)}</div>
            
            <div className="bg-white text-black rounded-lg p-4 mx-2">
              <div className="text-xs text-gray-700 mb-1">[서울중구투어패스] 서울중구투어패스 /</div>
              <div className="text-xs text-gray-700 mb-4">★추석맞이 특가★ 서울중구투어패스 기본권(24시간)</div>
              
              <div className="flex justify-center mb-3">
                <div className="flex items-end">
                  {Array.from({length: 40}, (_, i) => (
                    <div 
                      key={i} 
                      className={`${i % 3 === 0 ? 'bg-black' : 'bg-white border-r border-black'} ${
                        i % 7 === 0 ? 'h-12' : i % 5 === 0 ? 'h-10' : 'h-8'
                      } w-1`}
                    />
                  ))}
                </div>
              </div>
              <div className="text-center text-xs text-gray-600 mb-2">4291300054942500</div>
              <div className="text-center text-sm font-medium">성인 2</div>
            </div>
          </div>
        </div>
      </div>

      <div className="px-4 space-y-3 mb-4">
        <button 
          onClick={() => setShowDetail('favorites')}
          className="w-full bg-red-500 hover:bg-red-600 text-white py-4 rounded-lg font-medium flex items-center justify-center gap-2"
        >
          <User size={20} />
          {t.myFavorites} ({favorites.size}개 찜함)
        </button>
      </div>

      <div className="px-4 mb-4">
        <div className="relative overflow-hidden rounded-lg shadow-lg">
          <div 
            className="flex transition-transform duration-500 ease-in-out"
            style={{ transform: `translateX(-${currentBanner * 100}%)` }}
          >
            {bannerAds.map((banner, index) => (
              <div
                key={banner.id}
                className={`min-w-full bg-gradient-to-r ${banner.bgColor} p-4 flex items-center justify-between`}
              >
                <div className={banner.textColor}>
                  <h3 className="font-bold text-lg mb-1">{banner.title}</h3>
                  <p className="text-sm opacity-90">{banner.subtitle}</p>
                </div>
                <button 
                  onClick={() => handleBannerClick(banner)}
                  className="bg-white/20 backdrop-blur-sm text-white px-4 py-2 rounded-lg text-sm hover:bg-white/30 transition-colors"
                >
                  {banner.type === 'survey' ? '참여하기' : '자세히'}
                </button>
              </div>
            ))}
          </div>
          
          <div className="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex gap-2">
            {bannerAds.map((_, index) => (
              <button
                key={index}
                onClick={() => setCurrentBanner(index)}
                className={`w-2 h-2 rounded-full transition-colors ${
                  index === currentBanner ? 'bg-white' : 'bg-white/50'
                }`}
              />
            ))}
          </div>

          <button
            onClick={() => setCurrentBanner(prev => prev === 0 ? bannerAds.length - 1 : prev - 1)}
            className="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black/20 text-white p-1 rounded-full hover:bg-black/40"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M15 18L9 12L15 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
          </button>
          <button
            onClick={() => setCurrentBanner(prev => (prev + 1) % bannerAds.length)}
            className="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black/20 text-white p-1 rounded-full hover:bg-black/40"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M9 18L15 12L9 6" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
            </svg>
          </button>
        </div>
      </div>

      <div className="px-4">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-bold text-gray-900">{t.freeUse}</h2>
          <button className="bg-pink-500 text-white text-xs px-3 py-2 rounded-full">
            {t.viewFacilities}
          </button>
        </div>
        
        <div className="grid grid-cols-3 gap-3 mb-4">
          <div className="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow relative">
            <div className="h-20 bg-gradient-to-br from-green-400 to-green-600 relative flex items-center justify-center">
              <div className="text-white text-2xl">🏛️</div>
              <div
                onMouseDown={() => handleHeartClick('palace')}
                onTouchStart={() => handleHeartClick('palace')}
                className="absolute top-1 right-1 text-lg z-10 cursor-pointer select-none"
                style={{ userSelect: 'none', WebkitUserSelect: 'none' }}
              >
                {favorites.has('palace') ? '❤️' : '🤍'}
              </div>
            </div>
            <div 
              onClick={() => handleCardClick('palace')}
              className="p-2 cursor-pointer"
            >
              <div className="text-xs font-medium text-gray-900 mb-1">{t.deoksugung}</div>
              <div className="text-xs text-pink-500 mb-1">{t.freeEntry}</div>
              <div className="text-xs text-gray-500 mb-2">193.7Km</div>
              <div className="flex items-center justify-between">
                <span className="text-xs text-gray-500"></span>
                <div className="flex gap-1">
                  <div className="p-1">
                    <Phone size={10} className="text-gray-400" />
                  </div>
                  <div className="p-1">
                    <Map size={10} className="text-gray-400" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow relative">
            <div className="h-20 bg-gradient-to-br from-purple-400 to-purple-600 relative flex items-center justify-center">
              <div className="text-white text-2xl">☕</div>
              <div
                onMouseDown={() => handleHeartClick('cafe')}
                onTouchStart={() => handleHeartClick('cafe')}
                className="absolute top-1 right-1 text-lg z-10 cursor-pointer select-none"
                style={{ userSelect: 'none', WebkitUserSelect: 'none' }}
              >
                {favorites.has('cafe') ? '❤️' : '🤍'}
              </div>
            </div>
            <div 
              onClick={() => handleCardClick('cafe')}
              className="p-2 cursor-pointer"
            >
              <div className="text-xs font-medium text-gray-900 mb-1">{t.haity}</div>
              <div className="text-xs text-pink-500 mb-1">{t.drinkService}</div>
              <div className="text-xs text-gray-500 mb-2">193.7Km</div>
              <div className="flex items-center justify-between">
                <span className="text-xs text-gray-500"></span>
                <div className="flex gap-1">
                  <div className="p-1">
                    <Phone size={10} className="text-gray-400" />
                  </div>
                  <div className="p-1">
                    <Map size={10} className="text-gray-400" />
                  </div>
                  <div className="p-1">
                    <MessageCircle size={10} className="text-gray-400" />
                  </div>
                  <div className="p-1">
                    <Phone size={10} className="text-gray-400" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow relative">
            <div className="h-20 bg-gradient-to-br from-orange-400 to-orange-600 relative flex items-center justify-center">
              <div className="text-white text-2xl">🎨</div>
              <div
                onMouseDown={() => handleHeartClick('workshop')}
                onTouchStart={() => handleHeartClick('workshop')}
                className="absolute top-1 right-1 text-lg z-10 cursor-pointer select-none"
                style={{ userSelect: 'none', WebkitUserSelect: 'none' }}
              >
                {favorites.has('workshop') ? '❤️' : '🤍'}
              </div>
            </div>
            <div 
              onClick={() => handleCardClick('workshop')}
              className="p-2 cursor-pointer"
            >
              <div className="text-xs font-medium text-gray-900 mb-1">{t.laughingDayWorkshop}</div>
              <div className="text-xs text-pink-500 mb-1">{t.travelTopperExperience}</div>
              <div className="text-xs text-gray-500 mb-2">193.9K</div>
              <div className="flex gap-1">
                <div className="p-1">
                  <Phone size={10} className="text-gray-400" />
                </div>
                <div className="p-1">
                  <Map size={10} className="text-gray-400" />
                </div>
                <div className="p-1">
                  <MessageCircle size={10} className="text-gray-400" />
                </div>
                <div className="p-1">
                  <Phone size={10} className="text-gray-400" />
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <button className="w-full border border-gray-300 py-3 rounded-lg text-center text-gray-700 bg-white hover:bg-gray-50">
          {t.seeAll}
        </button>

        <div className="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg p-4 mt-4 text-white">
          <h3 className="font-bold mb-3">{t.popularDestinations}</h3>
          <div className="space-y-2">
            {statsData.topDestinations.map((dest, index) => (
              <div key={index} className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <span className="font-bold">{index + 1}위</span>
                  <span>{dest.name}</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-16 h-2 bg-white/30 rounded-full overflow-hidden">
                    <div 
                      className="h-full bg-white rounded-full"
                      style={{ width: `${dest.percentage}%` }}
                    />
                  </div>
                  <span className="text-sm">{dest.percentage}%</span>
                </div>
              </div>
            ))}
          </div>
          <div className="text-xs opacity-80 mt-2">전월 이용 고객 기준</div>
        </div>
      </div>

      <div className="fixed bottom-0 left-0 right-0 max-w-sm mx-auto bg-white border-t border-gray-200 grid grid-cols-5">
        <button 
          onClick={() => setShowPopup(true)}
          className="flex flex-col items-center py-3 hover:bg-gray-50"
        >
          <Bell size={20} className="text-gray-600 mb-1" />
          <span className="text-xs text-gray-600">{t.announcement}</span>
        </button>
        <button 
          onClick={startCamera}
          className="flex flex-col items-center py-3 hover:bg-gray-50"
        >
          <User size={20} className="text-gray-600 mb-1" />
          <span className="text-xs text-gray-600">QR인증</span>
        </button>
        <button 
          onClick={() => setShowDetail('courseRecommendation')}
          className="flex flex-col items-center py-3 hover:bg-gray-50"
        >
          <Map size={20} className="text-gray-600 mb-1" />
          <span className="text-xs text-gray-600">여행코스추천</span>
        </button>
        <button 
          onClick={() => setShowDetail('chatbot')}
          className="flex flex-col items-center py-3 hover:bg-gray-50"
        >
          <MessageCircle size={20} className="text-gray-600 mb-1" />
          <span className="text-xs text-gray-600">{t.chatbot}</span>
        </button>
        <button 
          onClick={() => setShowDetail('language')}
          className="flex flex-col items-center py-3 hover:bg-gray-50"
        >
          <Globe size={20} className="text-gray-600 mb-1" />
          <span className="text-xs text-gray-600">{t.language}</span>
        </button>
      </div>
    </div>
  );

  return (
    <div className="max-w-sm mx-auto bg-white relative">
      {mode === 'basic' ? <BasicMode /> : <div>Simple Mode</div>}

      {showPopup && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg p-6 w-full max-w-sm">
            <h3 className="text-lg font-bold mb-4 text-center text-red-600">{t.importantNotice}</h3>
            <div className="space-y-3 text-sm text-gray-700 mb-6">
              <div>• 일부 가맹점 운영시간이 변경되었습니다.</div>
              <div>• 카페허들&남산색방 2층 임시 휴관 (12/20~12/25)</div>
              <div>• 덕수궁 야간 개방 연장 운영 중</div>
            </div>
            <div className="flex gap-3">
              <button 
                onClick={handleHidePopupToday}
                className="flex-1 bg-gray-400 text-white py-3 rounded-lg font-medium hover:bg-gray-500"
              >
                오늘은 다시 안보기
              </button>
              <button 
                onClick={() => setShowPopup(false)}
                className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700"
              >
                {t.confirm}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Survey Modal */}
      {showSurvey && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg p-6 w-full max-w-sm">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-lg font-bold">투어패스 만족도 조사</h3>
              <button onClick={() => setShowSurvey(false)} className="p-1">
                <X size={20} className="text-gray-600" />
              </button>
            </div>

            {surveyStep < surveyQuestions.length ? (
              <>
                {/* Progress Bar */}
                <div className="mb-6">
                  <div className="flex items-center justify-between text-sm text-gray-600 mb-2">
                    <span>질문 {surveyStep + 1} / {surveyQuestions.length}</span>
                    <span>{Math.round(((surveyStep + 1) / surveyQuestions.length) * 100)}%</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className="bg-indigo-500 h-2 rounded-full transition-all duration-300"
                      style={{ width: `${((surveyStep + 1) / surveyQuestions.length) * 100}%` }}
                    />
                  </div>
                </div>

                <div className="mb-6">
                  <h4 className="font-medium mb-4 text-center">
                    {surveyQuestions[surveyStep].question}
                  </h4>
                  
                  <div className="space-y-3">
                    {surveyQuestions[surveyStep].options.map((option, index) => (
                      <button
                        key={index}
                        onClick={() => {
                          const newAnswers = {
                            ...surveyAnswers,
                            [surveyQuestions[surveyStep].id]: option.value
                          };
                          setSurveyAnswers(newAnswers);
                          
                          if (surveyStep < surveyQuestions.length - 1) {
                            setSurveyStep(surveyStep + 1);
                          } else {
                            // 설문 완료
                            setSurveyStep(surveyQuestions.length);
                          }
                        }}
                        className="w-full p-4 text-left border border-gray-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors"
                      >
                        <div className="flex items-center gap-3">
                          {option.emoji && (
                            <span className="text-2xl">{option.emoji}</span>
                          )}
                          <span className="font-medium">{option.label}</span>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>

                {surveyStep > 0 && (
                  <button
                    onClick={() => setSurveyStep(surveyStep - 1)}
                    className="w-full py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50"
                  >
                    이전 질문
                  </button>
                )}
              </>
            ) : (
              /* 설문 완료 */
              <div className="text-center py-8">
                <div className="text-6xl mb-4">🎉</div>
                <h3 className="text-xl font-bold mb-4">감사합니다!</h3>
                <p className="text-gray-600 mb-6">
                  소중한 의견을 주셔서 감사합니다.<br/>
                  더 나은 서비스를 위해 활용하겠습니다.
                </p>
                
                {/* 간단한 결과 표시 */}
                <div className="bg-indigo-50 rounded-lg p-4 mb-6">
                  <h4 className="font-medium mb-2">📊 설문 결과</h4>
                  <div className="text-sm space-y-2">
                    {surveyAnswers.satisfaction && (
                      <div>만족도: {surveyAnswers.satisfaction}/5</div>
                    )}
                    {surveyAnswers.recommendation && (
                      <div>추천 의향: {
                        surveyAnswers.recommendation === 'yes' ? '적극 추천' :
                        surveyAnswers.recommendation === 'maybe' ? '조건부 추천' : '비추천'
                      }</div>
                    )}
                  </div>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setSurveyStep(0);
                      setSurveyAnswers({});
                    }}
                    className="flex-1 py-3 text-indigo-600 border border-indigo-300 rounded-lg hover:bg-indigo-50"
                  >
                    다시 참여하기
                  </button>
                  <button
                    onClick={() => setShowSurvey(false)}
                    className="flex-1 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600"
                  >
                    완료
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {showDetail === 'courseRecommendation' && (
        <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
          <div className="p-4">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-lg font-bold">AI 여행코스 추천</h2>
              <button onClick={() => {
                setShowDetail(null);
                setCurrentQuestion(0);
                setUserAnswers({});
                setAiRecommendation(null);
                setIsAnalyzing(false);
              }} className="p-2">
                <X size={24} className="text-gray-600" />
              </button>
            </div>

            {!aiRecommendation ? (
              <>
                {!isAnalyzing ? (
                  <>
                    <div className="mb-6">
                      <div className="flex items-center justify-between text-sm text-gray-600 mb-2">
                        <span>질문 {currentQuestion + 1} / {questionData.length}</span>
                        <span>{Math.round(((currentQuestion + 1) / questionData.length) * 100)}%</span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-2">
                        <div 
                          className="bg-blue-500 h-2 rounded-full transition-all duration-300"
                          style={{ width: `${((currentQuestion + 1) / questionData.length) * 100}%` }}
                        />
                      </div>
                    </div>

                    <div className="mb-8">
                      <h3 className="text-lg font-medium mb-6 text-center">
                        {questionData[currentQuestion].question}
                      </h3>
                      
                      <div className="space-y-3">
                        {questionData[currentQuestion].options.map((option, index) => (
                          <button
                            key={index}
                            onClick={() => {
                              const newAnswers = {
                                ...userAnswers,
                                [questionData[currentQuestion].id]: option
                              };
                              setUserAnswers(newAnswers);
                              
                              if (currentQuestion < questionData.length - 1) {
                                setCurrentQuestion(currentQuestion + 1);
                              } else {
                                setIsAnalyzing(true);
                                setTimeout(() => {
                                  const recommendation = generateAIRecommendation(newAnswers);
                                  setAiRecommendation(recommendation);
                                  setIsAnalyzing(false);
                                }, 2000);
                              }
                            }}
                            className="w-full p-4 text-left border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors"
                          >
                            <span className="font-medium">{option}</span>
                          </button>
                        ))}
                      </div>
                    </div>

                    {currentQuestion > 0 && (
                      <button
                        onClick={() => setCurrentQuestion(currentQuestion - 1)}
                        className="w-full py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50"
                      >
                        이전 질문
                      </button>
                    )}
                  </>
                ) : (
                  <div className="text-center py-16">
                    <div className="animate-spin w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <h3 className="text-lg font-medium mb-2">AI가 분석 중입니다...</h3>
                    <p className="text-gray-600">당신의 취향에 맞는 최적의 코스를 찾고 있어요</p>
                  </div>
                )}
              </>
            ) : (
              <div className="space-y-6">
                <div className="bg-gradient-to-r from-green-400 to-blue-500 rounded-lg p-4 text-white">
                  <h3 className="font-bold text-lg mb-2">{aiRecommendation.title}</h3>
                  <p className="text-sm opacity-90">{aiRecommendation.description}</p>
                </div>

                <div className="space-y-4">
                  <h4 className="font-medium text-lg">추천 일정</h4>
                  {aiRecommendation.course.map((item, index) => (
                    <div key={index} className="bg-gray-50 rounded-lg p-4">
                      <div className="flex items-start gap-3">
                        <div className="bg-blue-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">
                          {index + 1}
                        </div>
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="font-medium text-blue-600">{item.time}</span>
                            <span className="text-sm text-gray-500">({item.duration})</span>
                          </div>
                          <h5 className="font-medium mb-1">{item.place}</h5>
                          <p className="text-sm text-gray-600">{item.activity}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <h5 className="font-medium text-yellow-800 mb-2">💡 여행 팁</h5>
                  <p className="text-sm text-yellow-700">{aiRecommendation.tip}</p>
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      setCurrentQuestion(0);
                      setUserAnswers({});
                      setAiRecommendation(null);
                    }}
                    className="flex-1 py-3 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50"
                  >
                    다시 추천받기
                  </button>
                  <button
                    onClick={() => setShowDetail(null)}
                    className="flex-1 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                  >
                    일정 확인완료
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {showDetail === 'favorites' && (
        <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
          <div className="p-4">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-lg font-bold">{t.favoritesTitle}</h2>
              <button onClick={() => setShowDetail(null)} className="p-2">
                <X size={24} className="text-gray-600" />
              </button>
            </div>

            <div className="space-y-4">
              {favorites.has('palace') && (
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="flex gap-4 mb-3">
                    <div className="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-lg flex items-center justify-center relative">
                      <div className="text-white text-2xl">🏛️</div>
                      <div
                        onMouseDown={() => toggleFavorite('palace')}
                        onTouchStart={() => toggleFavorite('palace')}
                        className="absolute -top-1 -right-1 text-lg cursor-pointer"
                      >
                        ❤️
                      </div>
                    </div>
                    <div className="flex-1">
                      <h3 className="font-medium text-gray-900 mb-1">{t.deoksugung}</h3>
                      <p className="text-sm text-pink-500 mb-1">{t.freeEntry}</p>
                      <p className="text-sm text-gray-500 mb-2">193.7Km</p>
                    </div>
                  </div>
                  <button className="w-full bg-pink-500 text-white py-2 rounded-lg text-sm font-medium">
                    {t.mobileAuth}
                  </button>
                </div>
              )}

              {favorites.has('cafe') && (
                <div className="bg-white rounded-lg shadow-sm p-4">
                  <div className="flex gap-4 mb-3">
                    <div className="w-20 h-20 bg-gradient-to-br from-purple-400 to-purple-600 rounded-lg flex items-center justify-center relative">
                      <div className="text-white text-2xl">☕</div>
                      <div
                        onMouseDown={() => toggleFavorite('cafe')}
                        onTouchStart={() => toggleFavorite('cafe')}
                        className="absolute -top-1 -right-1 text-lg cursor-pointer"
                      >
                        ❤️
                      </div>
                    </div>
                    <div className="flex-1">
                      <h3 className="font-medium text-gray-900 mb-1">{t.haity}</h3>
                      <p className="text-sm text-pink-500 mb-1">{t.drinkService}</p>
                      <p className="text-sm text-gray-500 mb-2">193.7Km</p>
                    </div>
                  </div>
                  <button className="w-full bg-pink-500 text-white py-2 rounded-lg text-sm font-medium">
                    {t.mobileAuth}
                  </button>
                </div>
              )}

              {favorites.size === 0 && (
                <div className="text-center py-8 text-gray-500">
                  {t.noFavorites}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {showScanner && (
        <div className="fixed inset-0 bg-black z-50 flex flex-col">
          <video 
            ref={videoRef}
            autoPlay 
            playsInline
            className="w-full h-full object-cover"
          />
          <div className="absolute inset-x-0 bottom-1/4 text-center text-white text-lg font-medium">
            QR을 프레임 안에 맞춰주세요
          </div>
          <button 
            onClick={stopCamera}
            className="absolute top-4 right-4 bg-transparent border border-white text-white px-4 py-2 rounded-lg flex items-center gap-2"
          >
            <X size={16} />
            닫기
          </button>
        </div>
      )}

      {showResult && scanResult && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg p-6 w-full max-w-sm">
            <h3 className="text-lg font-bold mb-4 text-center">인증 완료</h3>
            <div className="space-y-3 text-sm">
              <div>
                <span className="font-medium">인증시간:</span> {scanResult.time}
              </div>
              <div>
                <span className="font-medium">제공혜택:</span> {scanResult.benefit}
              </div>
              <div>
                <span className="font-medium">유의사항:</span> {scanResult.notice}
              </div>
            </div>
            <button 
              onClick={() => setShowResult(false)}
              className="w-full mt-6 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700"
            >
              확인
            </button>
          </div>
        </div>
      )}

      {showDetail === 'chatbot' && (
        <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
          <div className="p-4">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-lg font-bold">투어패스 도우미</h2>
              <button onClick={() => setShowDetail(null)} className="p-2">
                <X size={24} className="text-gray-600" />
              </button>
            </div>

            <div className="space-y-4 mb-20">
              <div className="flex gap-3">
                <div className="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                  <span className="text-white text-sm">🤖</span>
                </div>
                <div className="bg-gray-100 rounded-lg p-3 max-w-xs">
                  안녕하세요! 투어패스 이용에 도움이 필요하시면 언제든 문의해주세요. 어떤 도움이 필요하신가요?
                </div>
              </div>

              <div className="grid grid-cols-2 gap-2">
                <button className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-left hover:bg-blue-100">
                  🗺️ 추천 코스 문의
                </button>
                <button className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-left hover:bg-blue-100">
                  ⏰ 운영시간 확인
                </button>
                <button className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-left hover:bg-blue-100">
                  📱 사용법 안내
                </button>
                <button className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-left hover:bg-blue-100">
                  🎫 환불/취소 문의
                </button>
              </div>
            </div>

            <div className="fixed bottom-0 left-0 right-0 max-w-sm mx-auto bg-white border-t p-4">
              <div className="flex gap-2">
                <input 
                  type="text" 
                  placeholder="메시지를 입력하세요..."
                  className="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm"
                />
                <button className="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm">
                  전송
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {showDetail === 'language' && (
        <div className="fixed inset-0 bg-white z-50 overflow-y-auto">
          <div className="p-4">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-lg font-bold">언어 선택 / Language Selection</h2>
              <button onClick={() => setShowDetail(null)} className="p-2">
                <X size={24} className="text-gray-600" />
              </button>
            </div>

            <div className="space-y-3">
              <button 
                onClick={() => {
                  setLanguage('ko');
                  setShowDetail(null);
                }}
                className={`w-full p-4 rounded-lg border text-left ${language === 'ko' ? 'bg-blue-50 border-blue-500' : 'bg-white border-gray-200'}`}
              >
                <div className="font-medium">한국어</div>
                <div className="text-sm text-gray-600">Korean</div>
              </button>

              <button 
                onClick={() => {
                  setLanguage('en');
                  setShowDetail(null);
                }}
                className={`w-full p-4 rounded-lg border text-left ${language === 'en' ? 'bg-blue-50 border-blue-500' : 'bg-white border-gray-200'}`}
              >
                <div className="font-medium">English</div>
                <div className="text-sm text-gray-600">영어</div>
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default TourPassApp;
